<!DOCTYPE html>
<html>
<head>
<title>Marauder's Map</title>
<meta charset="utf-8" />
<link rel="stylesheet" href="style.css" />
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-i35yb5RVEpG1g4mPBM71eHeHrIGLRjw">
</script>
<script>

var map;
var lat;
var lng;
var chars;
/* SEND MY LOCATION */
        function initialize() {
        navigator.geolocation.getCurrentPosition(function(position) {
            lat = position.coords.latitude;
            lng = position.coords.longitude;
        
            var mapOptions = {
                center: { lat: position.coords.latitude, lng: position.coords.longitude},
                zoom: 13
            };
            getData(lat, lng);
            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions)
            });
        }
        
        
    function getData(lat, lng) {
        xhr = new XMLHttpRequest();
        xhr.open("post", "http://chickenofthesea.herokuapp.com/sendLocation", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
//                         console.log(xhr.responseText);
//                         var txt = document.getElementById("distances");
                        chars = JSON.parse(xhr.responseText);
//                         txt.innerHTML = chars;
                        printChars(chars);
                }
        }
        xhr.send("login=HannahAbbott&lat=" + lat + "&lng=" + lng);
    }
    
    function printChars(chars) {
        var txt = document.getElementById("distances");
        for (i = 0; chars['characters'][i]; i++) {
            txt.innerHTML = txt.innerHTML + "<p>" + chars['characters'][i]['name'] + "<br/>" + 
                  chars['characters'][i]['loc']['latitude'] + " " + 
                  chars['characters'][i]['loc']['longitude'] + "<br/>" + 
                  chars['characters'][i]['loc']['note'] + "</p>";
        }
        for (i = 1; chars['students'][i]; i++) {
            txt.innerHTML = txt.innerHTML + "<p>" + chars['students'][i]['login'] + "<br/>" + 
                  chars['students'][i]['lat'] + "<br/>" + chars['students'][i]['lng'] + "<br/>" + 
                  chars['students'][i]['created_at'] + "</p>";
        }
        createPersonalMarker(chars);
    }
    
    function createPersonalMarker(chars)
    {
        var me = new google.maps.LatLng(chars['students'][0]['lat'], chars['students'][0]['lat']);
        var marker = new google.maps.Marker({
            position: me,
            title: "Me"
        });
        var infowindow = new google.maps.InfoWindow();
        
        marker.setMap(map);
        
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(marker.title);
            infowindow.open(map, marker);
        });
    }
    
    google.maps.event.addDomListener(window, "load", initialize);
    
</script>
</head>

<body>
    <div id="map-canvas"></div>
    <div id="distances"></div>
</body>
</html>